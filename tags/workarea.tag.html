<workarea>
    <style>
        #work-canvas{
            position: absolute;
	        z-index: 1;
        }
        #canvas-container{
            height: calc(100vh - 150px);
            display: block;
            overflow: auto;
            position: relative;
        }
    </style>

    <div id="canvas-container">
        <img id="img" src={ opts.img.src } width="{ opts.img.size.width }" height="{ opts.img.size.height }"/>
        <div id="work-canvas" width="{ opts.img.size.width }" height="{ opts.img.size.height }"></div>
        <!-- <div id="img_overlay"></div> -->
        <span id="tooltip-span"></span>
    </div>

    <script>
        $(document).on('click', function(event){
            deselectAll();
            selectedElements = [];
        });

        $(document).keyup(function(e){
            if(e.keyCode == 46){
                selectedElements.forEach(el => {
                    /* $("[for="+ el.node.id+"]").remove(); */
                    el.selectize(false, {deepSelect:true})//unselect first
                    if(el.typ === 'point'){
                        detachPoint(el.attr("for") ,el.node.id);//delete it from store
                        el.remove();//remove parent svg node
                    }else{
                        detachShape(el.node.id);//delete it from store
                        el.parent().remove();//remove parent svg node
                    }
                });
                
                selectedElements = [];
                //delete all the points related to a polygon
                //show snakebar to inform
            }else if(e.keyCode == 65 && e.shiftKey){
                //Select all the labels
                console.log("selecting all")
                selectAll();
            }else if(e.keyCode == 65){
                /* allLabels.forEach(el => {
                    el.remove();
                }); */
            }
        });
        
        this.on('mount',function() {

            myCanvas = new SVG('work-canvas').size(opts.img.size.width, opts.img.size.height)/* .panZoom() */;

            myCanvas.on('mousedown', function(event){
                deselectAll();
                if(selectedTool && selectedTool.type !== "point" && !alreadyDrawing && selectedTool.drawable){
                    var currentTool = selectedTool.create(event,myCanvas);

                    currentTool.on('drawstart', function(){
                        alreadyDrawing = true;
                    });

                    currentTool.on('drawcancel', function(){
                        console.log("canceled")
                    });
                    currentTool.on('drawstop', function(){
                        alreadyDrawing = false;
                        if( !selectedTool.validate(currentTool)){//Don't draw an element on accidentle click
                            currentTool.parent().remove();
                            currentTool.remove();
                        }else{
                            //updateData(currentTool);
                            attachShapeData(currentTool);
                            currentTool.parent().on("click", function(e) {
                                if(selectedTool.type === "point"){
                                    var point = selectedTool.create(e,currentTool);
                                    point.typ = 'point';
                                    point.attr({
                                        for: currentTool.node.id
                                    })
                                    attachPointToShape(currentTool.node.id, point.node.id, point.rbox(myCanvas));
                                    point.on("click", function(e) {
                                        if(!e.ctrlKey){//deselect rest selected elements
                                            deselectAll();
                                        }
                                        point.selectize({ rotationPoint: false, points: []});
                                        selectedElements.push(point);
                                        e.stopPropagation();
                                    });
                                }else if(e.altKey){//deep select. Helpful in case of polygon
                                        deselectAll();
                                        currentTool.selectize({ rotationPoint: false, deepSelect:true});
                                        selectedElements.push(currentTool);    
                                }else{
                                    if(!e.ctrlKey){//deselect rest selected elements
                                        deselectAll();
                                    }
                                    //select currnt element
                                    currentTool.selectize({ rotationPoint: false});
                                    selectedElements.push(currentTool);
                                }
                                e.stopPropagation();
                            });
                        }
                    });//draw stop ends
                        
                    currentTool.draw(event);
                    selectedElement = currentTool;
                }
            });
            myCanvas.on('mouseup', function(event){
                if(selectedTool && selectedElement)   selectedElement.draw(event);
            });
            
        } );

        function deselectAll(){
            selectedElements.forEach(el => {
                el.selectize(false, {deepSelect:true});
                el.selectize(false);
            });
            selectedElements = [];
        }

        function selectAll(){
            myCanvas.each(function(i,shapeEl){
                shapeEl.forEach(function(el){
                    if(el.node.tagName = 'svg' ){
                        el.selectize({rotationPoint: false});
                        selectedElements.push(el);
                    }
                })
            });
        }

    //When create, move, resize, delete
    function attachShapeData(shape){//update data with shape detail

        var points;

        switch(shape.type){
            case "rect":
                var box = shape.rbox(myCanvas);
                points = [box.x, box.y, box.w, box.h];
                break;
            case "circle":
                var box = shape.rbox(myCanvas);
                points = [box.cx, box.cy, box.r];
                break;
            case "eclipse":
                var box = shape.rbox(myCanvas);
                points = [box.cx, box.cy, box.rx, box.ry];
                break;
            case "polygon":
                console.log(shape)
                console.log(shape.rbox(myCanvas))
                console.log(shape.array())
                console.log(shape.array().settle())
                console.log(shape.array().value)
                points = [];
                break;
            case "line":
                console.log(shape.array())
                points = [];
                break;
            case "path":
                console.log(shape.array())
                points = [];
                break;
        }
        attachShapeToImg(shape.node.id ,shape.type, shape.rbox(myCanvas), points);

    }

    </script>
</workarea>